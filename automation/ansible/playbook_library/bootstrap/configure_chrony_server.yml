---
- name: Configure Chrony Server Service
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - ../../group_vars/all.yml

  pre_tasks:

    # --------------------------------------------------
    # Normalize chrony_allow_networks from user input
    # --------------------------------------------------

    - name: Normalize chrony_allow_networks (string â†’ list)
      ansible.builtin.set_fact:
        chrony_allow_networks: "{{ chrony_allow_networks | split(',') }}"
      when:
        - chrony_allow_networks is defined
        - chrony_allow_networks | type_debug in ['AnsibleUnsafeText', 'str']

    # --------------------------------------------------
    # Auto-detect network only if user input is missing
    # --------------------------------------------------

    - name: Auto-detect default IPv4 network if chrony_allow_networks not provided
      ansible.builtin.set_fact:
        chrony_allow_networks:
          - "{{ ansible_default_ipv4.network }}/{{ ansible_default_ipv4.prefix }}"
      when:
        - chrony_allow_networks is not defined
        - ansible_default_ipv4 is defined

    # --------------------------------------------------
    # Hard validation (fail fast)
    # --------------------------------------------------

    - name: Validate chrony_allow_networks
      ansible.builtin.fail:
        msg: >
          chrony_allow_networks is undefined or empty.
          Provide one or more CIDR networks explicitly.
      when:
        - chrony_allow_networks is not defined or chrony_allow_networks | length == 0

    # --------------------------------------------------
    # Debug for visibility (very useful in production)
    # --------------------------------------------------

    - name: Debug chrony allow networks
      ansible.builtin.debug:
        msg:
          - "Chrony allow networks = {{ chrony_allow_networks }}"
          - "Type = {{ chrony_allow_networks | type_debug }}"

  roles:
    - role: "{{ roles_parent_path }}/bootstrap_lib/chrony_server"
