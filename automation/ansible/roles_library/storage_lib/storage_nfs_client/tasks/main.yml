---
# =============================================================================
# NFS CLIENT SETUP â€” ENTERPRISE SAFE (EL8 / EL9)
# =============================================================================

# ------------------------------------------------------------
# Reload systemd
# ------------------------------------------------------------
- name: Reload systemd manager configuration
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

# ------------------------------------------------------------
# Ensure local RPM directory exists
# ------------------------------------------------------------
- name: Ensure local NFS RPM directory exists
  ansible.builtin.file:
    path: "{{ nfs_rpm_dir }}"
    state: directory
    mode: "0755"

# ------------------------------------------------------------
# Gather installed RPMs
# ------------------------------------------------------------
- name: Gather installed RPM list
  ansible.builtin.command: rpm -qa --qf '%{NAME}\n'
  register: installed_rpms
  changed_when: false

# ------------------------------------------------------------
# Determine missing NFS client packages
# ------------------------------------------------------------
- name: Determine missing NFS client packages
  ansible.builtin.set_fact:
    missing_packages: "{{ nfs_client_packages | difference(installed_rpms.stdout_lines) }}"

- name: Show missing packages
  ansible.builtin.debug:
    msg: "Missing NFS client packages: {{ missing_packages }}"
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Check RPM availability on headnode
# ------------------------------------------------------------
- name: Check if NFS RPMs exist on headnode
  ansible.builtin.stat:
    path: "{{ nfs_rpm_dir }}"
  delegate_to: "{{ groups['headnode'][0] }}"
  run_once: true
  register: headnode_rpm_dir
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Sync RPMs from headnode if available
# ------------------------------------------------------------
- name: Sync RPMs from headnode
  ansible.builtin.synchronize:
    src: "{{ nfs_rpm_dir }}/"
    dest: "{{ nfs_rpm_dir }}/"
    mode: pull
  when:
    - missing_packages | length > 0
    - headnode_rpm_dir.stat.exists | default(false)

# ------------------------------------------------------------
# Find local RPMs for missing packages
# ------------------------------------------------------------
- name: Find local RPMs
  ansible.builtin.find:
    paths: "{{ nfs_rpm_dir }}"
    patterns: "{{ item }}-*.rpm"
  loop: "{{ missing_packages }}"
  register: found_rpms
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Attempt local RPM installation (NON-FATAL)
# ------------------------------------------------------------
- name: Attempt install from local RPMs
  ansible.builtin.command: >
    rpm -Uvh --nosignature
    {{ found_rpms.results | map(attribute='files') | flatten | map(attribute='path') | join(' ') }}
  register: local_rpm_install
  failed_when: false
  changed_when: local_rpm_install.rc == 0
  when:
    - missing_packages | length > 0
    - found_rpms.results | map(attribute='matched') | sum > 0

- name: Debug local RPM install failure
  ansible.builtin.debug:
    msg: "{{ local_rpm_install.stderr }}"
  when:
    - local_rpm_install is defined
    - local_rpm_install.rc != 0

# ------------------------------------------------------------
# Fallback: Install from network repository
# ------------------------------------------------------------
- name: Install NFS client packages from network repo
  ansible.builtin.package:
    name: "{{ missing_packages }}"
    state: present
  when:
    - missing_packages | length > 0
    - local_rpm_install is not defined
      or local_rpm_install.rc != 0

# ------------------------------------------------------------
# Final verification
# ------------------------------------------------------------
- name: Verify NFS client packages installed
  ansible.builtin.command: rpm -q {{ item }}
  loop: "{{ nfs_client_packages }}"
  register: verify_pkgs
  changed_when: false
  failed_when: false

# ------------------------------------------------------------
# Ensure services
# ------------------------------------------------------------
- name: Ensure rpcbind service running
  ansible.builtin.service:
    name: rpcbind
    state: started
    enabled: true
  ignore_errors: true

- name: Ensure NFS client target running
  ansible.builtin.service:
    name: nfs-client.target
    state: started
    enabled: true
  ignore_errors: true

# ------------------------------------------------------------
# Ensure NFS mount directories exist
# ------------------------------------------------------------
- name: Ensure NFS mount directories exist
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop: "{{ nfs_mounts | default([]) }}"
  loop_control:
    label: "{{ item.dest }}"

# ------------------------------------------------------------
# Mount NFS filesystems
# ------------------------------------------------------------
- name: Mount NFS filesystems
  ansible.builtin.mount:
    src: "{{ item.src }}"
    path: "{{ item.dest }}"
    fstype: "{{ item.fstype | default('nfs') }}"
    opts: "{{ item.opts | default('defaults,_netdev') }}"
    state: "{{ mounted_state }}"
  loop: "{{ nfs_mounts | default([]) }}"
  loop_control:
    label: "{{ item.src }} -> {{ item.dest }}"

