---

- name: Reload systemd manager configuration
  ansible.builtin.systemd:
    daemon_reload: yes
  become: true

- name: Ensure local NFS RPM directory exists
  ansible.builtin.file:
    path: "{{ nfs_rpm_dir }}"
    state: directory
    mode: "0755"
  vars:
    nfs_rpm_dir: "{{ rpm_stack_path | default('/tmp/rpm-stack') }}/nfs_rpms"

# ------------------------------------------------------------
# Gather installed packages
# ------------------------------------------------------------
- name: Gather installed packages
  ansible.builtin.command: rpm -qa --qf '%{NAME}\n'
  register: installed_rpms
  changed_when: false

- name: Determine missing NFS client packages
  ansible.builtin.set_fact:
    missing_packages: "{{ nfs_client_packages | difference(installed_rpms.stdout_lines) }}"

- name: Show missing packages
  ansible.builtin.debug:
    msg: "Missing NFS client packages: {{ missing_packages }}"
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Copy missing RPMs from headnode
# ------------------------------------------------------------
- name: Check if RPMs exist on headnode
  ansible.builtin.stat:
    path: "{{ nfs_rpm_dir }}"
  delegate_to: "{{ groups['headnode'][0] }}"
  register: headnode_rpm_dir
  run_once: true

- name: Copy missing RPMs from headnode if available
  ansible.builtin.synchronize:
    src: "{{ nfs_rpm_dir }}/"
    dest: "{{ nfs_rpm_dir }}/"
    mode: pull
  when:
    - missing_packages | length > 0
    - headnode_rpm_dir.stat.exists

# ------------------------------------------------------------
# Find RPMs locally on each client node
# ------------------------------------------------------------
- name: Find local RPMs for missing packages
  ansible.builtin.find:
    paths: "{{ nfs_rpm_dir }}"
    patterns: "{{ item }}-*.rpm"
  loop: "{{ missing_packages }}"
  register: found_rpms
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Install from local RPMs if found
# ------------------------------------------------------------
- name: Install NFS client packages from local RPMs
  ansible.builtin.command: >
    rpm -Uvh --nosignature
    {{ found_rpms.results | map(attribute='files') | flatten | map(attribute='path') | join(' ') }}
  when:
    - missing_packages | length > 0
    - found_rpms.results | map(attribute='matched') | sum > 0

# ------------------------------------------------------------
# Fallback: install missing packages from network repo
# ------------------------------------------------------------
- name: Install NFS client packages from network repo
  ansible.builtin.package:
    name: "{{ missing_packages }}"
    state: present
  when:
    - missing_packages | length > 0
    - found_rpms.results | map(attribute='matched') | sum == 0

# ------------------------------------------------------------
# Ensure NFS client services
# ------------------------------------------------------------
- name: Ensure rpcbind service is running and enabled
  ansible.builtin.service:
    name: rpcbind
    state: started
    enabled: true
  ignore_errors: true

- name: Ensure NFS client target is running and enabled
  ansible.builtin.service:
    name: nfs-client.target
    state: started
    enabled: true
  ignore_errors: true

# ------------------------------------------------------------
# Ensure NFS mount points exist
# ------------------------------------------------------------
- name: Ensure NFS mount point directories exist
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop: "{{ nfs_mounts | default([]) }}"
  loop_control:
    label: "{{ item.dest }}"

# ------------------------------------------------------------
# Mount NFS filesystems
# ------------------------------------------------------------
- name: Mount NFS filesystems
  ansible.builtin.mount:
    src: "{{ item.src }}"
    path: "{{ item.dest }}"
    fstype: "{{ item.fstype | default('nfs') }}"
    opts: "{{ item.opts | default('defaults,_netdev') }}"
    state: "{{ mounted_state }}"
  loop: "{{ nfs_mounts | default([]) }}"
  loop_control:
    label: "{{ item.src }} -> {{ item.dest }}"

