---
# ============================================================
# NFS Client Installation â€“ EL8 / EL9 (Rocky / RHEL / Alma)
# Strategy:
#   1. Check if NFS client packages are already installed
#   2. If missing, try installing from local RPMs
#   3. If local RPMs are not present, fallback to network repo
# ============================================================

- name: Ensure local NFS RPM directory exists
  ansible.builtin.file:
    path: "{{ nfs_rpm_dir }}"
    state: directory
    mode: "0755"

# ------------------------------------------------------------
# Detect installed packages
# ------------------------------------------------------------
- name: Gather installed packages
  ansible.builtin.command: rpm -qa --qf '%{NAME}\n'
  register: installed_rpms
  changed_when: false

- name: Determine missing NFS client packages
  ansible.builtin.set_fact:
    missing_packages: "{{ nfs_client_packages | difference(installed_rpms.stdout_lines) }}"

- name: Debug missing packages
  ansible.builtin.debug:
    msg: "Missing NFS client packages: {{ missing_packages }}"
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Check availability of local RPMs
# ------------------------------------------------------------
- name: Find local RPMs for missing packages
  ansible.builtin.find:
    paths: "{{ nfs_rpm_dir }}"
    patterns: "{{ item }}-*.rpm"
  loop: "{{ missing_packages }}"
  register: local_rpm_search
  when: missing_packages | length > 0

- name: Determine if all missing RPMs are available locally
  ansible.builtin.set_fact:
    local_rpms_available: >-
      {{
        local_rpm_search.results
        | map(attribute='matched')
        | min
        | default(0)
        | int > 0
      }}
  when: missing_packages | length > 0

# ------------------------------------------------------------
# Install from local RPMs (preferred)
# ------------------------------------------------------------
- name: Install NFS client packages from local RPMs
  ansible.builtin.command: >
    rpm -Uvh --nosignature --nodeps
    {{ local_rpm_search.results | map(attribute='files') | flatten | map(attribute='path') | join(' ') }}
  when:
    - missing_packages | length > 0
    - local_rpms_available | bool

# ------------------------------------------------------------
# Fallback: install from network repo (safe on fresh OS)
# ------------------------------------------------------------
- name: Install NFS client packages from network repository
  ansible.builtin.package:
    name: "{{ missing_packages }}"
    state: present
  when:
    - missing_packages | length > 0
    - not local_rpms_available | bool

# ------------------------------------------------------------
# Ensure NFS client service
# ------------------------------------------------------------
- name: Ensure NFS client services are enabled and running
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - rpcbind
    - nfs-client.target

# ------------------------------------------------------------
# Ensure NFS mount points exist
# ------------------------------------------------------------
- name: Ensure NFS mount point directories exist
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop: "{{ nfs_mounts | default([]) }}"
  loop_control:
    label: "{{ item.dest }}"

# ------------------------------------------------------------
# Mount NFS filesystems
# ------------------------------------------------------------
- name: Mount NFS filesystems
  ansible.builtin.mount:
    src: "{{ item.src }}"
    path: "{{ item.dest }}"
    fstype: "{{ item.fstype | default('nfs') }}"
    opts: "{{ item.opts | default('defaults,_netdev') }}"
    state: mounted
  loop: "{{ nfs_mounts | default([]) }}"
  loop_control:
    label: "{{ item.src }} -> {{ item.dest }}"
