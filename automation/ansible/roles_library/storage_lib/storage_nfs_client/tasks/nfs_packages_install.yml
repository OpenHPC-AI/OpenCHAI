---

# ------------------------------------------------------------
# Detect installed packages
# ------------------------------------------------------------

- name: Ensure required packages are installed using rpm only
  block:

    - name: Ensure Development RPM directory exists
      ansible.builtin.file:
        path: "{{ nfs_rpm_dir }}"
        state: directory
        mode: "0755"

    - name: Gather installed package list using rpm
      ansible.builtin.command: rpm -qa --qf '%{NAME}\n'
      register: installed_rpms
      changed_when: false

    - name: Determine missing required packages
      ansible.builtin.set_fact:
        missing_packages: "{{ required_packages | difference(installed_rpms.stdout_lines) }}"

    - name: Show missing packages
      ansible.builtin.debug:
        msg: "Missing packages: {{ missing_packages }}"
      when: missing_packages | length > 0

    - name: Find local RPMs for missing packages
      ansible.builtin.find:
        paths: "{{ nfs_rpm_dir }}"
        patterns: "{{ item }}-*.rpm"
      loop: "{{ missing_packages }}"
      register: found_rpms
      when: missing_packages | length > 0

    - name: Fail if any required RPM is missing locally
      ansible.builtin.fail:
        msg: "RPM for package {{ item.item }} not found in {{ nfs_rpm_dir }}"
      when:
        - missing_packages | length > 0
        - item.matched == 0
      loop: "{{ found_rpms.results }}"
      ignore_errors: true

    - name: Install missing packages using local RPMs
      ansible.builtin.command: >
        rpm -Uvh --nosignature --nodeps
        {{ found_rpms.results
           | map(attribute='files')
           | flatten
           | map(attribute='path')
           | join(' ') }}
      register: local_install
      when: missing_packages | length > 0
      ignore_errors: true

    - name: Set local install success flag
      ansible.builtin.set_fact:
        local_install_success: "{{ local_install.rc | default(1) == 0 }}"

# ------------------------------------------------------------
# HEADNODE fallback (optional)
# ------------------------------------------------------------

- name: Check headnode RPM directory
  ansible.builtin.stat:
    path: "{{ nfs_rpm_dir }}"
  delegate_to: "{{ groups['headnode'][0] }}"
  run_once: true
  register: headnode_rpm_dir
  failed_when: false

- name: Pull RPMs from headnode
  ansible.builtin.synchronize:
    src: "{{ nfs_rpm_dir }}/"
    dest: "{{ nfs_rpm_dir }}/"
    mode: pull
  when:
    - missing_packages | length > 0
    - not local_install_success
    - headnode_rpm_dir.stat.exists | default(false)
  failed_when: false

- name: Install from headnode RPMs
  ansible.builtin.command: rpm -Uvh --nosignature --force {{ nfs_rpm_dir }}/*.rpm
  register: headnode_install
  when:
    - missing_packages | length > 0
    - not local_install_success
    - headnode_rpm_dir.stat.exists | default(false)
  failed_when: false

# ------------------------------------------------------------
# FINAL fallback â€” public network repo
# ------------------------------------------------------------

- name: Install from public repository
  ansible.builtin.package:
    name: "{{ missing_packages }}"
    state: present
  when:
    - missing_packages | length > 0
    - not local_install_success
    - headnode_install.rc | default(1) != 0
