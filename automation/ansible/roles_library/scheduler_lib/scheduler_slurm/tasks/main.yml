---

- name: Download EPEL GPG key
  ansible.builtin.get_url:
    url: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-8
    dest: /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-8
    mode: '0644'


- name: Ensure EPEL release is installed
  ansible.builtin.dnf:
    name: epel-release
    state: present


# 1. Ensure CRB repo enabled
- name: Ensure CRB repository is enabled
  ansible.builtin.shell: |
    dnf config-manager --set-enabled crb || dnf config-manager --set-enabled powertools
  args:
    executable: /bin/bash
  changed_when: false


# 2. Install authentication packages
- name: Install authentication packages
  ansible.builtin.dnf:
    name: "{{ auth_packages }}"
    state: present

# 3. Install PMIx RPMs
- name: Install PMIx packages
  ansible.builtin.yum:
    name: "{{ lookup('fileglob', slurm_rpm_base + '/' + pmix_version + '/*.rpm', wantlist=True) }}"
    state: present
    disable_gpg_check: true

# 4. Gather list of Slurm RPMs
- name: Find Slurm RPMs
  ansible.builtin.find:
    paths: "{{ slurm_rpm_base }}/{{ slurm_version }}"
    patterns: "*.rpm"
  register: slurm_rpms

- debug:
    var: slurm_rpms


# 5. Filter Slurm RPMs based on role
- name: Extract basenames of slurm rpms
  set_fact:
    slurm_rpm_basenames: "{{ slurm_rpms.files | map(attribute='path') | map('basename') | list }}"

- debug:
    var: slurm_rpm_basenames

- name: Set filtered slurm packages
  set_fact:
    slurm_install_list: >-
      {{ slurm_rpm_basenames
         | reject('search', (slurm_excluded_packages[slurm_node_role] | map('regex_escape') | join('|')))
         | list }}

- name: Build install list with full paths
  set_fact:
    slurm_install_list: >-
      {{ slurm_rpms.files
         | map(attribute='path')
         | select('search', (slurm_install_list | join('|')))
         | list }}



- debug:
    var: slurm_rpms.files


- debug:
    var: slurm_install_list


# ðŸ”¹ Remove excluded packages only if reinstall requested
- name: Remove excluded packages for this role
  ansible.builtin.yum:
    name: "{{ slurm_excluded_packages[slurm_node_role] }}"
    state: absent
  when:
    - slurm_reinstall | default(false) | bool
    - slurm_excluded_packages[slurm_node_role] | length > 0

- name: Install allowed Slurm packages
  ansible.builtin.yum:
    name: "{{ slurm_install_list }}"
    state: present
    disable_gpg_check: true



# 6. Backup existing Slurm configs
- name: Backup existing slurm configs
  ansible.builtin.shell: >
    if [ -d /etc/slurm ]; then
      tar czf /etc/slurm_backup_$(date +%F_%H-%M-%S).tar.gz /etc/slurm/*.conf || true;
    fi
  args:
    executable: /bin/bash
  when: slurm_reinstall



- import_tasks: install.yml
