# ==========================================================
# Docker Engine Installation (Offline, ordered) for Rocky 9.6
# ==========================================================

- name: Check Docker RPM stack directory
  ansible.builtin.stat:
    path: "{{ docker_engine_rpm_stack_path }}"
  register: docker_rpm_dir

- name: Find Docker RPMs in local stack
  ansible.builtin.find:
    paths: "{{ docker_engine_rpm_stack_path }}"
    patterns: "*.rpm"
  register: docker_rpms
  when: docker_rpm_dir.stat.exists

- name: Decide Docker install source
  ansible.builtin.set_fact:
    docker_install_from_local: "{{ docker_rpms.matched | default(0) | int > 0 }}"

- name: Show Docker install source
  ansible.builtin.debug:
    msg: >
      Docker will be installed from {{"LOCAL RPM stack" if docker_install_from_local else "NETWORK repository"}}

# ----------------------------------------------------------
# Ordered offline installation from local RPMs
# ----------------------------------------------------------
- name: Install Docker dependencies from local RPMs
  ansible.builtin.dnf:
    name:
      # 1️⃣ Core system libraries (glibc, fuse, etc.)
      - "{{ docker_engine_rpm_stack_path }}/glibc-2.34-231.el9_7.2.i686.rpm"
      - "{{ docker_engine_rpm_stack_path }}/fuse3-3.10.2-9.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/fuse3-libs-3.10.2-9.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/fuse3-libs-3.10.2-9.el9.i686.rpm"
      - "{{ docker_engine_rpm_stack_path }}/libslirp-4.4.0-8.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/libslirp-4.4.0-8.el9.i686.rpm"
      - "{{ docker_engine_rpm_stack_path }}/slirp4netns-1.3.3-1.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/dnf-plugins-core-4.3.0-24.el9_7.noarch.rpm"
      - "{{ docker_engine_rpm_stack_path }}/container-selinux-2.240.0-3.el9_7.noarch.rpm"
      - "{{ docker_engine_rpm_stack_path }}/fuse-overlayfs-1.15-1.el9.x86_64.rpm"
    state: present
    disable_gpg_check: true
    disablerepo: '*'
    allowerasing: "{{ at_install_allow_erasing }}"
  when: docker_install_from_local
  register: deps_install_result
  ignore_errors: true

- name: Install Docker packages from local RPMs
  ansible.builtin.dnf:
    name:
      - "{{ docker_engine_rpm_stack_path }}/containerd.io-2.2.1-1.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/docker-ce-cli-29.1.3-1.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/docker-ce-rootless-extras-29.1.3-1.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/docker-ce-29.1.3-1.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/docker-buildx-plugin-0.30.1-1.el9.x86_64.rpm"
      - "{{ docker_engine_rpm_stack_path }}/docker-compose-plugin-5.0.0-1.el9.x86_64.rpm"
    state: present
    disable_gpg_check: true
    disablerepo: '*'
    allowerasing: "{{ at_install_allow_erasing }}"
  when: docker_install_from_local
  register: docker_install_result
  ignore_errors: true

- name: Determine if fallback to network repo is needed
  ansible.builtin.set_fact:
    fallback_to_network: "{{ (docker_install_result is failed or deps_install_result is failed) and not docker_install_from_local }}"

# ----------------------------------------------------------
# Fallback: network installation (only if allowed)
# ----------------------------------------------------------
- name: Configure Docker repository (network)
  import_tasks: docker_repo.yml
  when: fallback_to_network

- name: Install Docker Engine from network repository
  ansible.builtin.dnf:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: latest
    allowerasing: "{{ at_install_allow_erasing }}"
  when: fallback_to_network

# ----------------------------------------------------------
# Enable and start Docker service
# ----------------------------------------------------------
- name: Enable and start Docker service
  ansible.builtin.systemd:
    name: docker
    enabled: "{{ docker_service_enable }}"
    state: started
