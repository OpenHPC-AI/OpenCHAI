# tasks/swarm_join.yml

- name: Ensure swarm token directory exists
  file:
    path: "{{ rpm_stack_path }}/docker_swarm"
    state: directory
    mode: '0755'

- name: Read swarm manager join token from NFS mount
  slurp:
    src: "{{ rpm_stack_path }}/docker_swarm/swarm_token_file"
  register: swarm_token_data

- name: Set swarm join token fact
  set_fact:
    manager_join_token: "{{ swarm_token_data.content | b64decode | trim }}"

- name: Check if this node is already part of a swarm
  command: docker info --format '{{ "{{ .Swarm.LocalNodeState }}" }}'
  register: swarm_status
  failed_when: false
  changed_when: false

- name: Join node to Docker Swarm as manager
  command: >
    docker swarm join
    --token {{ manager_join_token }}
    --advertise-addr {{ ansible_host }}
    {{ primary_swarm_manager_ip }}:2377
  when: swarm_status.stdout != "active"
