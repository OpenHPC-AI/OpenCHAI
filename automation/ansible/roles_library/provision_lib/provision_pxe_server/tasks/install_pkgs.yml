---
- name: Ensure required directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ openchai_vault_path }}/iso-data"
    - "{{ iso_mount_path }}"

# ------------------------------------------------
# Install PXE packages (LOCAL RPMs first, SAFE fallback to network)
# ------------------------------------------------
- name: Install PXE packages from local RPMs or network (dependency-safe)
  ansible.builtin.shell: |
    set -e

    echo ">>> Checking local RPM availability in {{ pxe_rpm_path }}"

    if ls {{ pxe_rpm_path }}/*.rpm &>/dev/null; then
      echo ">>> Local RPMs found. Installing using DNF localinstall (dependency-safe)"
      dnf -y localinstall {{ pxe_rpm_path }}/*.rpm
    else
      echo ">>> No local RPMs found. Falling back to network install"
      dnf -y install {{ pxe_packages | join(' ') }}
    fi

    echo ">>> Verifying required packages are installed"
    for pkg in {{ pxe_packages | join(' ') }}; do
      rpm -q "$pkg" >/dev/null 2>&1 || {
        echo "!!! Package $pkg failed to install"
        exit 1
      }
    done

    echo ">>> PXE package installation completed successfully"
  args:
    executable: /bin/bash
