# ------------------------------------------------------------------
# DHCP Server Configuration (STATIC PXE ONLY)
# ------------------------------------------------------------------

authoritative;
default-lease-time 600;
max-lease-time 7200;

option domain-name-servers {{ dns_server }};

# PXELINUX / UEFI options
option space pxelinux;
option pxelinux.magic code 208 = string;
option pxelinux.configfile code 209 = text;
option pxelinux.pathprefix code 210 = text;
option pxelinux.reboottime code 211 = unsigned integer 32;
option architecture-type code 93 = unsigned integer 16;

# ------------------------------------------------------------------
# Subnet definition (NO dynamic range)
# ------------------------------------------------------------------
subnet {{ subnet_network }} netmask {{ subnet_netmask }} {

    option routers {{ pxe_server_ip }};
    option broadcast-address {{ subnet_network | regex_replace('0$', '255') }};

    # --------------------------------------------------------------
    # Static PXE nodes only (MAC based)
    # --------------------------------------------------------------
    {% for client in dhcp_clients %}
    host {{ client.name }} {
        hardware ethernet {{ client.mac }};
        fixed-address {{ client.ip }};
        option host-name "{{ client.name }}";
    }
    {% endfor %}

    # --------------------------------------------------------------
    # PXE boot handling (BIOS + UEFI)
    # --------------------------------------------------------------
    class "pxeclients" {
        match if substring(option vendor-class-identifier, 0, 9) = "PXEClient";

        next-server {{ pxe_server_ip }};

        if option architecture-type = 00:07 {
            filename "BOOTX64.EFI";     # UEFI x86_64
        }
        elsif option architecture-type = 00:09 {
            filename "BOOTX64.EFI";     # UEFI HTTP / newer firmware
        }
        else {
            filename "pxelinux.0";      # Legacy BIOS
        }
    }
}
