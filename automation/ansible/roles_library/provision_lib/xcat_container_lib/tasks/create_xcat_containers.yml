- name: Check if /drbd is mounted on active master node
  command: mountpoint -q /drbd
  register: drbd_active
  failed_when: false
  changed_when: false

- name: Skip xCAT container deployment on passive node
  when: drbd_active.rc != 0
  debug:
    msg: "⛔ Skipping xCAT container deployment because /drbd is not mounted on {{ inventory_hostname }}"





# -------------------------------------------------------------------
# Verify both files exist in /drbd/cont_env/
# -------------------------------------------------------------------
- name: Verify both docker-compose.yml and dev.env exist
  stat:
    path: "{{ item }}"
  register: file_check
  loop:
    - /drbd/cont_env/docker-compose.yml
    - /drbd/cont_env/dev.env
  when: drbd_mount_check.rc == 0

- name: Check that all files exist
  assert:
    that:
      - file_check.results | map(attribute='stat.exists') | list | min
    fail_msg: "❌ One or more required files are missing in /drbd/cont_env/"
    success_msg: "✅ Both docker-compose.yml and dev.env exist in /drbd/cont_env/"
  when: drbd_mount_check.rc == 0



# -------------------------------------------------------------------
# Copy updated dev.env as .env
# -------------------------------------------------------------------
- name: Copy dev.env to .env
  command: cp -ar /drbd/cont_env/dev.env /drbd/cont_env/.env
  args:
    creates: /drbd/cont_env/.env
  when: drbd_mount_check.rc == 0
# -------------------------------------------------------------------
# Restart the xCAT container stack
# -------------------------------------------------------------------
- name: Deploy or update the xcat_stack using docker-compose.yml
  command: docker stack deploy -c /drbd/cont_env/docker-compose.yml xcat_stack
  register: deploy_result
  when: drbd_mount_check.rc == 0
- name: Show deploy output
  debug:
    msg: "{{ deploy_result.stdout_lines }}"
  when: drbd_mount_check.rc == 0

# -------------------------------------------------------------------
# Verify xcat_stack services
# -------------------------------------------------------------------
- name: Verify stack and services
  shell: |
    docker stack ls && echo "----" && docker service ls
  register: stack_status
  changed_when: false

- name: Show stack verification output
  debug:
    msg: "{{ stack_status.stdout_lines }}"

# -------------------------------------------------------------------
# Wait until xcat service reaches 1 running task
# -------------------------------------------------------------------
- name: Wait for xcat service to reach running state
  shell: |
    docker service ps xcat_stack_xcat --format '{{"{{"}}.CurrentState{{"}}"}}'
  register: xcat_state
  until: "'Running' in xcat_state.stdout"
  retries: 30          # = ~5 minutes (30 × 10s)
  delay: 10
  changed_when: false
  failed_when: false

- name: Show xCAT service task state
  debug:
    msg: "xCAT task state: {{ xcat_state.stdout }}"

# -------------------------------------------------------------------
# Verify running containers (Replica 1/1)
# -------------------------------------------------------------------
- name: Check running xCAT containers
  shell: docker ps --filter 'name=xcat' --format '{{"{{"}}.Names{{"}}"}}'
  register: running_containers
  changed_when: false
  when: drbd_mount_check.rc == 0

- name: Show container status
  debug:
    msg: "{{ running_containers.stdout_lines }}"
  when: drbd_mount_check.rc == 0
