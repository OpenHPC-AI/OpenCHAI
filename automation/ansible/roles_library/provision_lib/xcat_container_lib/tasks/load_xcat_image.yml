---
# tasks/load_xcat_image.yml
# Purpose: Copy or download xCAT image, then load it on both master nodes.

- name: Ensure xCAT repo directory exists
  file:
    path: /hpctool_stack/xcat_repo
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if xCAT image already exists locally
  stat:
    path: "/hpctool_stack/xcat_repo/{{ xcat_container_img }}"
  register: xcat_img_local

- name: Copy xCAT image from mounted registry if available
  copy:
    src: "{{ hpcsuite_registry_mount_path }}/container_img_reg/xCAT_reg/{{ xcat_container_img }}"
    dest: "/hpctool_stack/xcat_repo/"
    mode: '0644'

  when:
    - not xcat_img_local.stat.exists
    - hpcsuite_registry_mount_path is defined
    - lookup('fileglob', hpcsuite_registry_mount_path + '/container_img_reg/xCAT_reg/*', errors='ignore') | length > 0
  ignore_errors: yes

- name: Check again if image exists after copy attempt
  stat:
    path: "/hpctool_stack/xcat_repo/{{ xcat_container_img }}"
  register: xcat_img_after_copy

- name: Download xCAT image from URL if not present locally or not copied
  get_url:
    url: "{{ xcat_reg_network_url }}"
    dest: "/hpctool_stack/xcat_repo/{{ xcat_container_img }}"
    mode: '0644'
    validate_certs: "{{ ssl_certificate_check }}"
  when: not xcat_img_after_copy.stat.exists
  retries: 3
  delay: 5
  register: download_result
  until: download_result is succeeded


- name: Verify xCAT image file presence after copy/download
  stat:
    path: "/hpctool_stack/xcat_repo/{{ xcat_container_img }}"
  register: xcat_img_check
  failed_when: not xcat_img_check.stat.exists

- name: Load xCAT Docker image
  command: >
    docker load --input /hpctool_stack/xcat_repo/{{ xcat_container_img }}
  register: docker_load
  changed_when: "'Loaded image' in docker_load.stdout or 'Loaded image' in docker_load.stderr"


- name: Display Docker load status
  debug:
    msg: "xCAT image version {{ xcat_version }} successfully loaded on {{ inventory_hostname }}"

