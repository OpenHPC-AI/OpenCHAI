---
# -------------------------------------------------------------
# Detect if /drbd is mounted
# -------------------------------------------------------------
- name: Check if /drbd is mounted
  command: mountpoint -q /drbd
  register: drbd_mount_check
  failed_when: false
  changed_when: false

# -------------------------------------------------------------------
# Deploy xCAT docker-compose file with automatic image detection
# -------------------------------------------------------------------

- name: Detect xCAT Docker image (if xcat_image not provided)
  shell: |
    docker images --format '{{ "{{.Repository}}:{{.Tag}}" }}' | grep -i 'cdac_xcat' | head -n 1
  register: detected_xcat_image
  changed_when: false
  when: xcat_image is not defined or xcat_image == ""

- name: Fail if no xCAT image found locally
  fail:
    msg: "❌ No xCAT image found locally. Please load or pull the xCAT container image first."
  when:
    - (xcat_image is not defined or xcat_image == "")
    - detected_xcat_image.stdout == ""

- name: Set xCAT image fact
  set_fact:
    xcat_image: "{{ detected_xcat_image.stdout if (xcat_image is not defined or xcat_image == '') else xcat_image }}"

- name: Display selected xCAT image
  debug:
    msg: "✅ Using xCAT image: {{ xcat_image }}"

# -------------------------------------------------------------------
# Generate docker-compose file using detected/defined image
# -------------------------------------------------------------------
- name: Generate docker-compose.yml with xCAT image
  template:
    src: docker-compose.yml.j2
    dest: /drbd/cont_env/docker-compose.yml
    mode: '0644'
  when: drbd_mount_check.rc == 0

- name: Confirm docker-compose.yml creation
  debug:
    msg: "✅ docker-compose.yml generated successfully at /drbd/cont_env/docker-compose.yml"


- name: Display final confirmation
  debug:
    msg: "✅ All files copied to /drbd/cont_env successfully."

