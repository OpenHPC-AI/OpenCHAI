---
# Remove conflicting DRBD packages if allowed
- name: Remove conflicting DRBD packages if allowed
  ansible.builtin.package:
    name: "{{ conflicting_drbd_pkg_rhel9 if rhel_major_version == 9 else conflicting_drbd_pkg_rhel8 }}"
    state: absent
  when: allow_package_removal | default(false)

# Determine DRBD RPM path based on RHEL version
- name: Set DRBD RPM directory path
  ansible.builtin.set_fact:
    drbd_rpm_dir: "{{ hpcsuite_registry_mount_path }}/hostmachine_reg/{{ os_version }}/{{ chai_version }}/drbd_pcs_rpms"

# Check if DRBD RPM directory exists
- name: Check if DRBD RPM directory exists
  ansible.builtin.stat:
    path: "{{ drbd_rpm_dir }}"
  register: drbd_rpm_dir_stat

# Find local RPMs only if directory exists
- name: Find local RPM files
  ansible.builtin.find:
    paths: "{{ drbd_rpm_dir }}"
    patterns: "*.rpm"
  register: local_rpms
  when: drbd_rpm_dir_stat.stat.exists

# Install PCS + DRBD packages from local RPMs using rpm
- name: Install PCS + DRBD packages from local RPMs
  ansible.builtin.command: >
    rpm -Uvh --force --nodeps --nosignature {{ item.path }}
  loop: "{{ local_rpms.files }}"
  register: drbd_rpm_install_results
  changed_when: true
  failed_when: >
    (drbd_rpm_install_results.rc | default(0) != 0)
    and ('NOKEY' not in (drbd_rpm_install_results.stdout | default('')))
    and ('NOKEY' not in (drbd_rpm_install_results.stderr | default('')))
  when:
    - drbd_use_local_rpms | default(false)
    - local_rpms is defined
    - local_rpms.files | length > 0

# Debug output (optional)
- name: Debug RPM install output (optional)
  ansible.builtin.debug:
    var: drbd_rpm_install_results.results
  when: ansible_verbosity | int > 0
