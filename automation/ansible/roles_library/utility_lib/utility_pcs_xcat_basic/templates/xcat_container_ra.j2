#!/bin/bash

# Pacemaker/systemd wrapper for Docker Swarm–managed xCAT container
# Correctly coordinates DRBD + Swarm + PCS semantics
#

# -----------------------------
# Configurable variables
# -----------------------------
STACK_NAME="{{ xcat_stack_name | default('xcat_stack') }}"
SERVICE_NAME="{{ xcat_service_name | default('xcat') }}"
SERVICE="${STACK_NAME}_${SERVICE_NAME}"
DRBD_MOUNT="{{ drbd_mount_dir | default('/drbd') }}"
TIMEOUT={{ xcat_start_timeout | default(60) }}

log() {
  echo "[xcat-container][$(hostname)] $*"
}

service_replicas() {
  docker service inspect "$SERVICE" \
    --format '{{ "{{.Spec.Mode.Replicated.Replicas}}" }}' 2>/dev/null
}

container_running_here() {
  docker ps \
    --filter "name=${SERVICE}" \
    --filter "status=running" \
    --format '{{ "{{.ID}}" }}' | grep -q .
}

wait_for_container() {
  for i in $(seq 1 "$TIMEOUT"); do
    container_running_here && return 0
    sleep 1
  done
  return 1
}

case "$1" in
  start)
    log "START called"

    # If DRBD is not mounted here, this resource must NOT run here.
    # This is a valid passive success for Pacemaker.
    if ! mountpoint -q "$DRBD_MOUNT"; then
      log "DRBD not mounted locally → start not applicable on this node"
      exit 0
    fi

    log "Ensuring Swarm service $SERVICE is running"
    docker service scale "$SERVICE=1" >/dev/null 2>&1

    if wait_for_container; then
      log "xCAT container is running"
      exit 0
    else
      log "FAILED: xCAT container did not start within timeout"
      exit 1
    fi
    ;;

  stop)
    log "STOP called"

    log "Scaling Swarm service $SERVICE to 0"
    docker service scale "$SERVICE=0" >/dev/null 2>&1

    for i in $(seq 1 "$TIMEOUT"); do
      container_running_here || exit 0
      sleep 1
    done

    log "FAILED: container still running"
    exit 1
    ;;

  monitor)
    if mountpoint -q "$DRBD_MOUNT"; then
      # DRBD active here → container MUST be running
      container_running_here || exit 1
      exit 0
    else
      # DRBD not active here → resource must be reported stopped
      exit 7
    fi
    ;;

  restart)
    $0 stop
    sleep 2
    $0 start
    exit $?
    ;;

  *)
    echo "Usage: $0 {start|stop|monitor|restart}"
    exit 1
    ;;
esac
