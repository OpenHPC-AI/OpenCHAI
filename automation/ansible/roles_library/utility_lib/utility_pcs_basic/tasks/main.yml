---

# ------------------------------------------------------------
# Load DRBD kernel module
# ------------------------------------------------------------
- name: Load DRBD kernel module
  ansible.builtin.command: modprobe drbd
  register: drbd_modprobe
  changed_when: drbd_modprobe.rc == 0
  failed_when: drbd_modprobe.rc != 0


# ------------------------------------------------------------
# Verify DRBD kernel module is loaded (safe, no shell)
# ------------------------------------------------------------
- name: Verify DRBD kernel module is loaded
  ansible.builtin.command: lsmod
  register: lsmod_out
  changed_when: false
  failed_when: "'drbd' not in lsmod_out.stdout"


# Ensure DRBD directory exists
- name: Ensure DRBD mount directory exists
  ansible.builtin.file:
    path: "{{ drbd_mount_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Force gather network facts
  ansible.builtin.setup:
    gather_subset:
      - network



# ------------------------------------------------------------
# Collect interface list
# ------------------------------------------------------------
- name: Collect interface list
  command: ip -o link show
  register: interface_list
  changed_when: false


# ------------------------------------------------------------
# Verify vip_interface exists (kernel name or altname)
# ------------------------------------------------------------
- name: Check if vip_interface exists
  set_fact:
    interface_exists: >-
      {{ vip_interface in interface_list.stdout
         or 'altname ' ~ vip_interface in interface_list.stdout }}

- name: Fail if vip_interface does not exist
  fail:
    msg: "Interface {{ vip_interface }} not found on this system"
  when: not interface_exists


# ------------------------------------------------------------
# Normalize altname â†’ kernel name
# ------------------------------------------------------------
- name: Normalize vip_interface if altname is provided
  set_fact:
    vip_interface: >-
      {{
        (
          interface_list.stdout
          | regex_findall(
              '^\\d+: ([^:]+):.*altname ' ~ vip_interface,
              multiline=True
            )
          | first
        )
        | default(vip_interface, true)
      }}
  when: "'altname ' ~ vip_interface in interface_list.stdout"


# ------------------------------------------------------------
# Get MAC address safely (NO regex_search)
# ------------------------------------------------------------
- name: Get link info for {{ vip_interface }}
  command: ip -o link show {{ vip_interface }}
  register: vip_link_info
  changed_when: false

- name: Extract MAC address for {{ vip_interface }}
  set_fact:
    vip_mac: >-
      {{
        vip_link_info.stdout
        | regex_findall('link/(?:ether|infiniband) ([0-9a-f:]{17})')
        | first
        | default('')
      }}

- name: Validate MAC address
  fail:
    msg: "MAC address not found for interface {{ vip_interface }}"
  when: vip_mac == ''


# ------------------------------------------------------------
# Create Virtual IP alias config
# ------------------------------------------------------------
- name: Configure virtual IP interface for cluster
  ansible.builtin.template:
    src: ifcfg-virtual.j2
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ vip_interface }}:0"
    owner: root
    group: root
    mode: '0644'





- name: Restart pcsd to bring up pcs service for further processes
  ansible.builtin.systemd:
    name: pcsd
    state: restarted
    enabled: true



# 3. Ensure cluster user exists
- name: Ensure cluster user "hacluster" exists
  ansible.builtin.user:
    name: hacluster
    password: "{{ pcs_cluster_password | password_hash('sha512') }}"
    shell: /bin/bash
    state: present

# 4. Authenticate cluster nodes
- name: Authenticate cluster nodes
  ansible.builtin.command: >
    pcs host auth {{ primary_master_node_hostname }} {{ secondary_master_node_hostname }}
    -u hacluster -p {{ pcs_cluster_password }}
  register: pcs_auth
  changed_when: "'already authorized' not in pcs_auth.stdout"
  failed_when: pcs_auth.rc != 0 and "'already authorized' not in pcs_auth.stdout"


- name: Debug hostname matching logic
  ansible.builtin.debug:
    msg:
      - "inventory_hostname = {{ inventory_hostname }}"
      - "ansible_hostname = {{ ansible_hostname }}"
      - "primary_master_node_hostname = {{ primary_master_node_hostname }}"
      - "Comparison (inventory_hostname == primary_master_node_hostname): {{ inventory_hostname == primary_master_node_hostname }}"
      - "Comparison (ansible_hostname == primary_master_node_hostname): {{ ansible_hostname == primary_master_node_hostname }}"



# 5. Setup PCS cluster (only on primary)
- name: Setup PCS cluster
  ansible.builtin.command: >
    pcs cluster setup {{ pcs_cluster_name }}
    {{ primary_master_node_hostname }} {{ secondary_master_node_hostname }} --force
  when: primary_master_node_hostname in [inventory_hostname, ansible_hostname]
  register: pcs_cluster_setup
  changed_when: "'already configured' not in pcs_cluster_setup.stderr and 'already set up' not in pcs_cluster_setup.stderr"
  failed_when: pcs_cluster_setup.rc != 0 and
               "'already configured' not in pcs_cluster_setup.stderr and
               'already set up' not in pcs_cluster_setup.stderr"




- name: Ensure PCS cluster services are started and enabled
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - pcsd
    - pacemaker
    - corosync



- name: Check status of PCS cluster services
  ansible.builtin.command: "systemctl status {{ item }}"
  register: pcs_services_status
  changed_when: false
  loop:
    - pcsd
    - pacemaker
    - corosync

- name: Display PCS cluster service status output
  ansible.builtin.debug:
    msg: "{{ item.stdout }}"
  loop: "{{ pcs_services_status.results }}"


# 6. Enable & start the cluster
- name: Enable PCS cluster on all nodes
  ansible.builtin.command: pcs cluster enable --all
  changed_when: true

- name: Start PCS cluster on all nodes
  ansible.builtin.command: pcs cluster start --all
  changed_when: true

- name: Comment out DRBD entries from /etc/fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^(?!#)(.*(\/drbd|drbd\d+).*)$'
    replace: '# \1'
    backup: yes
    validate: 'mount -a -f -T %s'




# Create Virtual IP network alias configuration file
- name: Configure virtual IP interface for cluster
  ansible.builtin.template:
    src: ifcfg-virtual.j2
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ vip_interface }}:0"
    owner: root
    group: root
    mode: '0644'


- name: Ensure VIP not bound to wrong interfaces
  ansible.builtin.command: ip addr del {{ vip_ip }}/{{ vip_prefix }} dev {{ item }}
  loop: "{{ ansible_interfaces }}"
  ignore_errors: true
  when: item != vip_interface







- name: Restart NetworkManager to bring up virtual IP interface
  ansible.builtin.systemd:
    name: NetworkManager
    state: restarted
    enabled: true
  register: nm_restart
  changed_when: nm_restart.state == "restarted"
  tags: [initscript]



# Check existing filesystem (primary only)
- name: Check existing filesystem on DRBD device
  command: "blkid -o value -s TYPE {{ drbd_device }}"
  register: drbd_fs_check
  failed_when: false
  changed_when: false
  when: primary_master_node_hostname in [inventory_hostname, ansible_hostname]

- name: Wait until PCS cluster is clean and nodes are online
  command: pcs status
  register: pcs_status
  retries: 20
  delay: 5
  until:
    #    - "'Current DC:' in pcs_status.stdout"
    #    - "'UNCLEAN' not in pcs_status.stdout"
    - "'Online:' in pcs_status.stdout"
  changed_when: false





# -------------------------------------------------------------
# Create mount directory
# -------------------------------------------------------------
- name: Create /drbd mountpoint
  file:
    path: /drbd
    state: directory
    mode: "0755"

# -------------------------------------------------------------
# Mount DRBD device
# -------------------------------------------------------------
- name: Mount DRBD device to /drbd
  mount:
    path: /drbd
    src: "{{ drbd_device }}"
    fstype: ext4
    state: "{{ mounted_state }}"
  when: primary_master_node_hostname in [inventory_hostname, ansible_hostname]


########################################
# PCS + DRBD + VIP + Docker (Primary only)
########################################

- block:

    ########################################
    # 1. Cluster defaults
    ########################################
    - name: Set PCS defaults
      command: >
        pcs resource defaults update
        migration-threshold=10
        resource-stickiness=100
        startdelay=45s


    ########################################
    # 2. Virtual IP
    ########################################
    - name: Create VIP resource
      command: >
        pcs resource create vip_xCAT ocf:heartbeat:IPaddr2
        ip={{ vip_ip }} cidr_netmask={{ vip_prefix }}
        op monitor interval=10s timeout=20s
        op start interval=0s timeout=20s
        op stop interval=0s timeout=20s


    ########################################
    # 3. DRBD promotable resource
    ########################################
    - name: Create DRBD resource (promotable)
      command: >
        pcs resource create drbdfs ocf:linbit:drbd
        drbd_resource={{ drbd_resource_name }}
        op monitor role=Master interval=20s timeout=90
        op monitor role=Slave interval=30s timeout=90
        op start timeout=240
        op stop timeout=100
        op reload timeout=30
        promotable


    ########################################
    # 4. DRBD filesystem
    ########################################
    - name: Create DRBD filesystem resource
      command: >
        pcs resource create xcatfs ocf:heartbeat:Filesystem
        device={{ drbd_device }}
        directory={{ drbd_mount_dir }}
        fstype={{ drbd_fstype }}
        op monitor interval=20s timeout=40s
        op start interval=0s timeout=60s
        op stop interval=0s timeout=60s


    ########################################
    # 5. Docker service (must stop first)
    ########################################
    - name: Create Docker PCS resource
      command: >
        pcs resource create docker systemd:docker
        op start timeout=120
        op stop timeout=120
        op monitor interval=30s timeout=60s


    ########################################
    # 6. Colocation constraints
    ########################################
    - name: Colocate filesystem with DRBD master
      command: >
        pcs constraint colocation add
        xcatfs with master drbdfs-clone

    - name: Colocate VIP with DRBD master
      command: >
        pcs constraint colocation add
        vip_xCAT with master drbdfs-clone

    - name: Colocate Docker with filesystem
      command: >
        pcs constraint colocation add
        docker with xcatfs


    ########################################
    # 7. Ordering constraints (CRITICAL)
    ########################################
    - name: Stop docker before filesystem
      command: >
        pcs constraint order
        stop docker then stop xcatfs

    - name: Unmount filesystem before DRBD demote
      command: >
        pcs constraint order
        stop xcatfs then demote drbdfs-clone

    - name: Promote DRBD before filesystem mount
      command: >
        pcs constraint order
        promote drbdfs-clone then start xcatfs

    - name: Start filesystem before docker
      command: >
        pcs constraint order
        start xcatfs then start docker

    - name: VIP follows DRBD master
      command: >
        pcs constraint order
        promote drbdfs-clone then start vip_xCAT

    - name: Stop VIP before DRBD demote
      command: >
        pcs constraint order
        stop vip_xCAT then demote drbdfs-clone


    ########################################
    # 8. Location preferences (PRIMARY > SECONDARY)
    ########################################
    - name: Prefer DRBD master on primary node
      command: >
        pcs constraint location
        drbdfs-clone prefers {{ primary_master_node_hostname }}=200

    - name: Prefer DRBD master on secondary node
      command: >
        pcs constraint location
        drbdfs-clone prefers {{ secondary_master_node_hostname }}=100

    - name: Prefer VIP on primary node
      command: >
        pcs constraint location
        vip_xCAT prefers {{ primary_master_node_hostname }}=200

    - name: Prefer VIP on secondary node
      command: >
        pcs constraint location
        vip_xCAT prefers {{ secondary_master_node_hostname }}=100


    ########################################
    # 9. DRBD clone tuning
    ########################################
    - name: Tune DRBD clone properties
      command: >
        pcs resource update drbdfs-clone
        notify=true
        master-node-max=1
        master-max=1
        clone-node-max=1
        clone-max=2

  when: ansible_hostname == primary_master_node_hostname
