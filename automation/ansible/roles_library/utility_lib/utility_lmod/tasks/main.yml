
---

- name: Detect OS major version
  ansible.builtin.set_fact:
    os_major_version: "{{ ansible_distribution_major_version }}"

- name: Check if Lmod or lmod-hpc is installed
  ansible.builtin.shell: "rpm -qa | grep -E '^(Lmod|lmod-hpc)'"
  register: lmod_check
  failed_when: false
  changed_when: false

# 1. Ensure HISTTIMEFORMAT is set in /etc/bashrc
- name: Ensure HISTTIMEFORMAT is set in /etc/bashrc
  ansible.builtin.lineinfile:
    path: /etc/bashrc
    regexp: '^export HISTTIMEFORMAT='
    line: "{{ histtimeformat_line }}"
    state: present
    insertafter: EOF

# 2. Install Development Tools group
- name: Install Development Tools group
  ansible.builtin.yum:
   name: "@Development Tools"
   state: present
  ignore_errors: yes

# 3. Install extra packages
- name: Install extra development packages
  ansible.builtin.yum:
    name: "{{ extra_packages }}"
    state: present
  ignore_errors: yes

# 4. Remove old environment-modules
- name: Remove old environment-modules package
  ansible.builtin.yum:
    name: "{{ old_modules_package }}"
    state: absent
    autoremove: no
  ignore_errors: yes


# Determine DRBD RPM path based on RHEL version
- name: Set Development RPM directory path
  ansible.builtin.set_fact:
    drbd_rpm_dir: "{{ hpcsuite_registry_mount_path }}/hostmachine_reg/{{ os_version }}/{{ chai_version }}/developement_rpms"

# Check if DRBD RPM directory exists
- name: Check if Development RPM directory exists
  ansible.builtin.stat:
    path: "{{ drbd_rpm_dir }}"
  register: drbd_rpm_dir_stat

# Find local RPMs only if directory exists
- name: Find local RPM files
  ansible.builtin.find:
    paths: "{{ drbd_rpm_dir }}"
    patterns: "*.rpm"
  register: local_rpms
  when: drbd_rpm_dir_stat.stat.exists

# Install PCS + DRBD packages from local RPMs using rpm
- name: Install Development packages from local RPMs
  ansible.builtin.command: >
    rpm -Uvh --force --nodeps --nosignature {{ item.path }}
  loop: "{{ local_rpms.files }}"
  register: drbd_rpm_install_results


# 5. Try to install lmod-hpc from local RPMs
#     paths: "{{ local_rpm_base }}/el{{ os_major_version }}"

- name: Find local Lmod RPMs
  ansible.builtin.find:
    paths: "{{ local_rpm_base }}/"
    patterns:
      - "lmod-hpc*.rpm"
      - "Lmod*.rpm"
      - "lua*.rpm"
  register: local_lmod_rpms
  when: lmod_check.stdout == ""


- name: Install Lmod from local RPMs using rpm command
  ansible.builtin.command:
    cmd: "rpm -Uvh --force {{ local_lmod_rpms.files | map(attribute='path') | join(' ') }}"
  when: lmod_check.stdout == "" and local_lmod_rpms.matched > 0
  register: local_rpm_install


- name: Install Lmod from local RPMs using yum
  ansible.builtin.yum:
    name: "{{ local_lmod_rpms.files | map(attribute='path') | list }}"
    state: present
  when: lmod_check.stdout == "" and local_lmod_rpms.matched > 0
  register: local_rpm_install
  ignore_errors: yes

# 6. Fallback: install Lmod from EPEL if local RPMs not found
- name: Install epel-release if needed
  ansible.builtin.yum:
    name: epel-release
    state: present
  when: lmod_check.stdout == "" and (local_lmod_rpms is not defined or local_lmod_rpms.matched == 0)

- name: Install Lmod from repos (EPEL)
  ansible.builtin.yum:
    name: Lmod
    state: present
  when: lmod_check.stdout == "" and (local_lmod_rpms is not defined or local_lmod_rpms.matched == 0)

# 7. Deploy lmod.sh profile script
- name: Deploy lmod.sh profile script
  ansible.builtin.template:
    src: lmod.sh.j2
    dest: /etc/profile.d/lmod.sh
    owner: root
    group: root
    mode: '0644'

# 8. Configure MODULEPATH
- name: Configure MODULEPATH
  ansible.builtin.copy:
    dest: /etc/profile.d/00-modulepath.sh
    owner: root
    group: root
    mode: '0644'
    content: |
      [ -z "$MODULEPATH" ] &&
        [ "$(readlink /etc/alternatives/modules.sh)" = "/usr/share/lmod/lmod/init/profile" -o -f /etc/profile.d/z00_lmod.sh ] &&
        export MODULEPATH={{ modulepath_dir }}:/etc/modulefiles || :
