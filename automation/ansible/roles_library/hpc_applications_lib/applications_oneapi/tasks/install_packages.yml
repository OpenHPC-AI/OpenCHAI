---


- name: Ensure required packages are installed using rpm only
  block:

    - name: Ensure Development RPM directory exists
      ansible.builtin.file:
        path: "{{ dev_rpm_path }}"
        state: directory
        mode: "0755"

    - name: Gather installed package list using rpm
      ansible.builtin.command: rpm -qa --qf '%{NAME}\n'
      register: installed_rpms
      changed_when: false

    - name: Determine missing required packages
      ansible.builtin.set_fact:
        missing_packages: "{{ required_packages | difference(installed_rpms.stdout_lines) }}"

    - name: Show missing packages
      ansible.builtin.debug:
        msg: "Missing packages: {{ missing_packages }}"
      when: missing_packages | length > 0

    - name: Find local RPMs for missing packages
      ansible.builtin.find:
        paths: "{{ dev_rpm_path }}"
        patterns: "{{ item }}-*.rpm"
      loop: "{{ missing_packages }}"
      register: found_rpms
      when: missing_packages | length > 0

    - name: Fail if any required RPM is missing locally
      ansible.builtin.fail:
        msg: "RPM for package {{ item.item }} not found in {{ dev_rpm_path }}"
      when:
        - missing_packages | length > 0
        - item.matched == 0
      loop: "{{ found_rpms.results }}"

    - name: Install missing packages using rpm
      ansible.builtin.command: >
        rpm -Uvh --nosignature --nodeps
        {{ found_rpms.results | map(attribute='files') | flatten | map(attribute='path') | join(' ') }}
      when: missing_packages | length > 0
